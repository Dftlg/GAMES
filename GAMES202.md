# Lecture3

## Shadow Mapping

存在问题：

**自遮挡**

![image-20220410163204864](GAMES202/image-20220410163204864.png)

由于场景投影到光源计算的深度时，其深度图是离散的像素点，对于单个像素存储了显示场景中类似于一条正方体射线的深度，其中一个值直接表示了一个小平面深度。从而产生自模糊。

**解决方式**

通过加上一个bias去调整实际深度

**走样**

![image-20220410165343604](GAMES202/image-20220410165343604.png)

## Second-depth shadow mapping

![image-20220410164314567](GAMES202/image-20220410164314567.png)

存阴影贴图时不仅仅存最小的深度，同时存储第二小深度，并将最小深度和第二小深度平均计算中间深度当作阴影贴图。

存在问题：

1. 模型需要有两个面，不能像地板

2. 需要计算多次深度，虽然时间复杂度还是O(n)，但依旧难以应用到实时

   

![image-20220410170141953](GAMES202/image-20220410170141953.png)

![image-20220410170329561](GAMES202/image-20220410170329561.png)

下面一项是归一化常数

比如f(x)函数为2的常值函数，可以把2提出积分，从而下面的归一化常数为2

![image-20220410193752548](GAMES202/image-20220410193752548.png)

什么时候积分是可以近似的

1. 其积分的区域很小，如点光源或者直接光照
2. 另外后面的积分项是平滑的积分，如面光源

## PCSS(Percentage closer soft shadows)

### Percentage Closer Filtering(PCF)

使用了一种抗锯齿技术，同时可被用于生成软阴影

在PCSS中这种Filter并不是使用在以下两种过程中

1. 并不使用在最后生成场景阶段，并不是完全生成完包含阴影的场景，然后进行模糊
2. 并不使用在生成阴影贴图阶段



## VSSM Variance Soft Shadow Mapping

针对PCSS第一步和第三步需要对Texture进行多次采样慢的问题

#### 针对第三步加速解决方案

问题转换：在第三步中需要对一个区域内的采样点比较深度值并计算平均的0-1之间的一个值，那么从另一个角度上看，是为了求比中间采样点深度值低的点（一定区域就是指采样深度值的区域）

怎么获取得知比已知深度值更低的结果

使用直方图或正态分布可以近似估计可以研究该深度值在所有深度值大概排第几。

![image-20220414192143556](GAMES202/image-20220414192143556.png)

正态分布如何获得？需要均值以及期望方差

**VSSM基本思想是**：

​	**使用正态分布区估计该深度值所在区域内的所在位置（或者使用其他分布）**

##### 使用正态分布去估计

###### 步骤一求解正态分布

​	**为求解正态分布需要在一定区域内快速计算深度的均值以及方差。**

如何求解均值方法可以使用

1. ​	**硬件的MipMAPing方法**
2. ​	**Summed Area Tables(SAT)**

如何求解方差可以使用

1. $$
   Var(X)=E(X^2)-E^2(X)
   $$

   E(X)指的就是该区域的深度平均值

   前面一项的计算需要另一张深度图，深度图中每一个值是原深度图的平方倍（可以将另一张深度图生成到另一个图象通道中）成为square-depth map

   

###### 步骤二使用CDF估计所在位置

![image-20220414194226896](GAMES202/image-20220414194226896.png)

在的到CDF图后，那么问在一个区域内深度值比1(中间像素)小的像素应该有多少个

也就是CDF函数小于1的面积，可通过将CDF转换为PDF求解

对于CDF的面积可以直接使用表(误差函数)去获取



##### 另一种方法使用切比雪夫不等式直接估计

使用不等式Chebychev不等式(切比雪夫不等式)

可以的到随机变量，超过某一个值得概率，但又不需要知道这个分布是什么，只需要知道期望和方差

注意：这个t需要在均值得右边才好用

![image-20220414195658869](GAMES202/image-20220414195658869.png)

在VSSM里直接近似估计将小于等于号直接改为约定于

#### VSSM的性能

**内存消耗：**

需要一张额外的平方深度图

**计算性能：**

1. 对深度图进行一次平均O(1)
2. 对平方深度图进行平均计算O(1)
3. 切比雪夫不等式计算O(1) 是否可见

#### 针对第一步加速方案

第一步需要计算遮挡物的平均深度Zocc

![image-20220415182458503](GAMES202/image-20220415182458503.png)

即蓝色部分的平均深度

Key idea:

在一个渲染点的深度是t，在遮挡物区域需要计算比其小的所有像素的平均值记录为
$$
Z_{occ}
$$
不是遮挡物的平均深度记录为
$$
Z_{unocc}
$$
两个平均深度未知，但其一定满足
$$
\frac{N1}{N}Z_{unocc}+\frac{N2}{N}Z_{occ}=Z_{Avg}
$$
两个区域的平均值和等于总区域的平均值，为求解Zocc提出了两个假设：

**假设一：**使用切比雪夫去估计概率：
$$
那么\frac{N1}{N}=P可以使用切比雪夫不等式来大概估计其概率,\frac{N2}{N}=1-P
$$
**假设二：**直接人为Zunocc的深度值为渲染点的深度值。

这样可以直接求解Zocc

## 快速计算均值和方差方法

被应用于VSSM中

### 1.MINMAP

![image-20220415185252332](GAMES202/image-20220415185252332.png)

### 2.Summed Area Tables(SAT)

#### 一维情况：

![image-20220415185727595](GAMES202/image-20220415185727595.png)

给一个范围内求平均=给一个范围求总和

SAT做了预处理操作

##### 预计算过程

先花O(n)时间

将每一格累加

1：1

4:1+3

9:1+3+5

12:1+3+5+3 ...

那么给定任意一段，比如3-7-1这一段

如何知道他们三个的和

**可以使用SAT中1对应的20减去3前一个数5对应的9来的到其加和**

#### 二维情况：

![image-20220415190302047](GAMES202/image-20220415190302047.png)

对于蓝色矩形的平均值

为绿色矩形区域的和值减去两个黄色区域的和值加上左上角重叠区域(小绿色区域的和值)

##### 预计算过程

生成一张图，该图中任意一个像素点(x,y)的值为从(0,0)左上角到(x,y)像素点这个矩形区域所有像素点的和

进行两次一维SAT计算

需要时间O(mn)

## Moment shadow mapping

解决了VSSM问题

![image-20220415191511240](GAMES202/image-20220415191511240.png)

例如第二个图，不能假设维正太分布

遮挡物的分布应该聚集在一个三个峰值的分布，不能用高斯分布区近似

![image-20220415191752077](GAMES202/image-20220415191752077.png)

人们通常能融入过黑的阴影，但过白的阴影无法接受

例如加入只有百分之20的挡不住，但分布认为有百分之50挡不住

![image-20220415192001409](GAMES202/image-20220415192001409.png)

#### Idea

避免VSSM的分布问题

使用更高阶的矩去描述一个分布

![image-20220415192551991](GAMES202/image-20220415192551991.png)

![image-20220415192629272](GAMES202/image-20220415192629272.png)

矩指的是记录一个数的平方，三次方，四次方

Vssm记录了一个一次放和二次方的项。

结论如果保留m阶的矩可一个得到m/2的台阶

![image-20220415192801325](GAMES202/image-20220415192801325.png)

类似于某种展开，可以获取到更好的CDF函数，而不是正态分布

![image-20220415193245998](GAMES202/image-20220415193245998.png)

# Lecture5

